<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100..700;1,100..700&family=Yusei+Magic&family=Zen+Maru+Gothic&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <title>Cuppy-Journey</title>
    <style>
        body {
            font-family: "Yusei Magic", serif;
        }
        #map {
            height: 87.5vh;
            width: 100%;
            /* background-color: #7EDCF8; */
        }
        #searchInput {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            width: 80%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .btn-group {
            position: absolute;
            bottom: 0;
            width: 100%;
            background-color: #f7dbdc;
        }
        .btn-primary {
            width: 25%;
            padding: 20px;
            border: none;
            background-color: #f7dbdc;
            color: #CC6B69;
            font-size: 1.4rem;
        }
        .btn-primary:hover {
            background-color: #CC6B69;
            color: #f7dbdc;
        }
        .btn.btn-primary:active {
            background-color: #a85352 !important; /* 強制覆蓋 */
            color: #ffffff !important; /* 強制修改文字顏色 */
            box-shadow: inset 0px 4px 6px rgba(0, 0, 0, 0.2); /* 點擊時的按壓效果 */
            border-color: #a85352 !important; /* 防止邊框顏色也被影響 */
        }
        .btn.active {
            background-color: #e0b5b7 !important; /* 當前頁面的背景色 */
            color: #b34846 !important; /* 當前頁面的文字顏色 */
            border: 2px solid #d48887; /* 可選：添加白色邊框 */
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2); /* 按壓效果 */
        }
    </style>
</head>
<body>
    <!-- 搜索框 -->
    <input id="searchInput" type="text" placeholder="輸入飲料店，例如 五桐號清大店">
    <!-- 地圖容器 -->
    <div id="map"></div>

    <script>
        function initMap() {
            // 初始化地圖，設定位置和縮放級別
            const center = { lat: 24.786680585228307, lng: 120.98827921202404 }; // 台積館 經緯度
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 15, // 縮放級別
                center: center, // 地圖中心點
            });

            // 顯示足跡
            displayFootprintsWithRoutes(map);

            // 初始化 Marker 和 InfoWindow
            const marker = new google.maps.Marker({
                map: map,
                visible: false, // 初始化時標記隱藏
            });

            const infoWindow = new google.maps.InfoWindow();
            
            // 初始化 Places Autocomplete
            const input = document.getElementById("searchInput");
            const autocomplete = new google.maps.places.Autocomplete(input);

            // 限制搜尋範圍
            autocomplete.setFields(["geometry", "name", "formatted_address"]);

            // 當用戶選擇地點時觸發
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) {
                    alert("無法找到該地點，請重新輸入！");
                    return;
                }

                // 更新地圖中心和標記
                map.setCenter(place.geometry.location);
                map.setZoom(17);
                marker.setPosition(place.geometry.location);
                marker.setVisible(true);

                // 更新資訊視窗內容並顯示
                infoWindow.setContent(`
                    <div>
                        <h5>${place.name}</h5>
                        <p>${place.formatted_address}</p>
                        <button 
                            onclick="redirectToAdd('${place.name}', '${place.formatted_address}', '${place.geometry.location.lat()}', '${place.geometry.location.lng()}')"
                            style="
                                padding: 10px 15px;
                                background-color: #CC6B69;
                                color: white;
                                border: none;
                                border-radius: 5px;
                                cursor: pointer;
                                font-size: 14px;">
                            確認店家
                        </button>
                    </div>
                `);
                infoWindow.open(map, marker);
            });
        }
        // 定義 redirectToAdd 函數
        function redirectToAdd(name, address, lat, lng) {
            // 將店家資訊存入 localStorage
            const storeData = {
                name: name,
                address: address, 
                lat: lat,
                lng: lng
            };
            localStorage.setItem('selectedStore', JSON.stringify(storeData));

            // 跳轉到 add.html 頁面
            window.location.href = 'add.html';
        }

        async function fetchFootprints() {
            const apiUrl = 'https://script.google.com/macros/s/AKfycbyD_LXpUnn6BSWGIMiyvWtXJW11QfsYyn6xCgwY5L-cmn6jSO4z3oJBXt0Z6Rk3tgND/exec'; // 替換為你的 Apps Script 部署 URL

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error("Failed to fetch data");
                
                const footprints = await response.json();
                return footprints;
            } catch (error) {
                console.error("Error fetching footprints:", error);
                return [];
            }
        }

        async function displayFootprintsWithRoutes(map) {
            const footprints = await fetchFootprints();

            if (footprints.length < 2) {
                console.warn("Not enough footprints to display routes.");
                return;
            }

            const bounds = new google.maps.LatLngBounds();
            const directionsService = new google.maps.DirectionsService();

            for (let i = 0; i < footprints.length - 1; i++) {
                const origin = { lat: footprints[i].lat, lng: footprints[i].lng };
                const destination = { lat: footprints[i + 1].lat, lng: footprints[i + 1].lng };

                addMarker(map, footprints[i], bounds);

                // 計算路徑顏色的深淺，範圍從 #FFDDDD（淺紅）到 #CC0000（深紅）
                const color = getGradientColor("#8E8E8E", "#000000", i / (footprints.length - 1));

                // 使用 DirectionsService 計算路徑
                const route = await calculateRoute(origin, destination);

                // **繪製白色底線**
                new google.maps.Polyline({
                    path: route, // 路徑座標
                    strokeColor: "#FFFFFF", // 白色底線
                    strokeOpacity: 1,
                    strokeWeight: 6, // 底線稍微比上層線粗
                    map: map,
                });
                
                // 使用 Polyline 渲染路徑為虛線
                new google.maps.Polyline({
                    path: route, // 路徑座標
                    strokeColor: color, // 線的顏色
                    strokeOpacity: 0, // 線透明，通過圖標模擬虛線
                    strokeWeight: 5, // 線的寬度
                    map: map,
                    icons: [
                        {
                            icon: {
                                path: "M 0,-1 0,1", // 定義虛線樣式
                                strokeOpacity: 1,
                                scale: 3,
                            },
                            offset: "0",
                            repeat: "10px", // 定義虛線的間隔
                        },
                    ],
                });
            }
            addMarker(map, footprints[footprints.length - 1], bounds);

            // 在最新紀錄點添加 Cuppy PNG
            const latestFootprint = footprints[footprints.length - 1];
            const latestPosition = { lat: latestFootprint.lat, lng: latestFootprint.lng };

            const cuppyMarker = new google.maps.Marker({
                position: latestPosition,
                map: map,
                title: "Latest Location",
                icon: {
                    url: "pictures/cuppy_full.png", // 替換為你的 Cuppy 圖片 URL
                    scaledSize: new google.maps.Size(30, 40), // 調整圖片大小
                    anchor: new google.maps.Point(15, 50), // 圖片的錨點（相對於底部）
                },
            });

            map.fitBounds(bounds);
        }

        // 工具函數：計算路徑座標
        async function calculateRoute(origin, destination) {
            const directionsService = new google.maps.DirectionsService();

            try {
                const response = await directionsService.route({
                    origin: origin,
                    destination: destination,
                    travelMode: google.maps.TravelMode.DRIVING, // 可以更改為 WALKING, BICYCLING, TRANSIT
                });

                if (response.routes[0]) {
                    return response.routes[0].overview_path; // 返回路徑的 LatLng 座標數組
                } else {
                    console.error("No routes found between origin and destination.");
                    return [];
                }
            } catch (error) {
                console.error("Failed to calculate route:", error);
                return [];
            }
        }

        // 工具函數：計算並顯示路徑
        async function calculateAndDisplayRoute(service, renderer, origin, destination) {
            try {
                const response = await service.route({
                    origin: origin,
                    destination: destination,
                    travelMode: google.maps.TravelMode.DRIVING, // 或 WALKING, BICYCLING, TRANSIT
                });

                renderer.setDirections(response); // 使用傳入的 renderer 顯示路徑
            } catch (error) {
                console.error("Failed to render route:", error);
            }
        }

        //工具函數: 添加標記
        function addMarker(map, record, bounds) {
            const marker = new google.maps.Marker({
                position: { lat: record.lat, lng: record.lng },
                map: map,
                title: record.shop,
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div>
                        <h5>${record.shop}</h5>
                        <p>地址：${record.address}</p>
                        <p>日期：${record.date.split('T')[0].replace(/-/g, '/')}</p>
                        <p>飲料：${record.drink} (${record.sugarIce})</p>
                    </div>
                `,
            });

            marker.addListener("click", () => {
                infoWindow.open(map, marker);
            });

            bounds.extend(marker.getPosition());
        }

        // 工具函數：計算漸變顏色
        function getGradientColor(startColor, endColor, percentage) {
            const startRGB = hexToRgb(startColor);
            const endRGB = hexToRgb(endColor);
            const r = Math.round(startRGB.r + percentage * (endRGB.r - startRGB.r));
            const g = Math.round(startRGB.g + percentage * (endRGB.g - startRGB.g));
            const b = Math.round(startRGB.b + percentage * (endRGB.b - startRGB.b));
            return `rgb(${r}, ${g}, ${b})`;
        }

        // 工具函數：將 HEX 顏色轉換為 RGB
        function hexToRgb(hex) {
            const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
            hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);

            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result
                ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16),
                }
                : null;
        }
    </script>

    <!-- 加載 Google Maps JavaScript API -->
    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAAeSuw_qxOX0wFAHk-zHPt8VwTOmG_JE8&libraries=places&language=zh-TW&callback=initMap">
    </script>

    <div class="btn-group" role="group">
        <a href="home.html" class="btn btn-primary">
        <i class="bi bi-house"></i>
        </a>
        <a href="journey.html" class="btn btn-primary active">
        <i class="bi bi-map"></i>
        </a>
        <a href="journal.html" class="btn btn-primary">
        <i class="bi bi-journal"></i>
        </a>
        <a href="add.html" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i>
        </a>
    </div>
</body>
</html>
